<!DOCTYPE html>
<html layout:decorate="~{layouts/layout2}"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org">

<!-- 사용자 CSS 추가 -->
<th:block layout:fragment="css">
    <style>
    </style>
</th:block>

<div layout:fragment="content">
    <div id="container">
        <div id="shop">
            <div id="shop_cart">
                <div class="wrap">
                    <div id="heading">장바구니</div>
                    <div class="step">
                        <ul>
                            <li class="active">장바구니</li>
                            <li>주문서 작성</li>
                            <li>주문완료</li>
                        </ul>
                    </div>
                    <div class="cartbox">
                        <div class="cart">
                            <div class="tool">
                                <button type="button">선택상품 삭제하기</button>
                                <button type="button">전체상품 삭제하기</button>
                            </div>
                            <div class="list">
                                <table id="cart_table">
                                    <thead>
                                    <tr>
                                        <th scope="col">
                                            <label class="checkbox">
                                                <input type="checkbox" name="allCartItemCheck" id="all_check_box"
                                                       onclick="allCheck()"><i></i>
                                                <p class="skip">전체 상품 선택</p>
                                            </label>
                                        </th>
                                        <th scope="col">주문상품</th>
                                        <th scope="col">가격</th>
                                        <th scope="col">수량</th>
                                        <th scope="col">총금액</th>
                                        <th scope="col">적립금</th>
                                        <th scope="col"><p class="skip">장바구니 제거</p></th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <th:block th:each="cartItem: ${cart.getCartItems()}">
                                        <tr>
                                            <td>
                                                <label class="checkbox">
                                                    <input type="checkbox" name="cartItemCheck" th:id="check_ + ${cartItem.getId()}" onchange="onChangeCheckBox()"><i></i>
                                                    <p class="skip">상품 선택</p>
                                                </label>
                                            </td>
                                            <td>
                                                <div class="prod">
                                                    <div class="img">
                                                        <img th:src="${cartItem.getMainImageUrl()}"></div>
                                                    <div class="con">
                                                        <div class="tit">
                                                            <span th:if="${cartItem.getBrand() != null && cartItem.getBrand() != ''}">
                                                                [<span th:text="${cartItem.getBrand()}">르라보</span>]
                                                            </span>
                                                            <span th:text="${cartItem.getName()}">어나더 13EDP 50ml</span>
                                                        </div>
                                                        <div class="opt">
                                                            <span th:if="${cartItem.getOption() != null}">
                                                                <span th:text="${cartItem.getOption().getName()}">용량 : 50ml </span>
                                                                <a href="javascript:;">옵션변경</a>
                                                            </span>
                                                            <span th:if="${cartItem.getOption() == null}">
                                                                <span>- </span>
                                                                <a href="javascript:;">옵션변경</a>
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <span th:text="${#numbers.formatInteger(cartItem.getPrice(), 0, 'COMMA')}" th:id="cart_item_price_+${cartItem.getId()}">349,000</span>원
                                                <!-- <br><em>($135,58)</em>-->
                                            </td>
                                            <td>
                                                <div class="amount">
                                                    <div class="inp">
                                                        <input type="text" onchange="changeCountCartItem(event)"
                                                               th:value="${cartItem.getCount()}" th:id="item_count_ + ${cartItem.getId()}"
                                                               onKeyup="this.value=this.value.replace(/[^0-9]/g,'');">
                                                    </div>
                                                    <div class="ctl">
                                                        <a onclick="changeOneCount('add', event)" th:id="cart_item_add_+${cartItem.getId()}">
                                                            <img src="/img/icon_amount_up.png" th:id="cart_item_add_+${cartItem.getId()}">
                                                        </a>
                                                        <a onclick="changeOneCount('dec', event)" th:id="cart_item_dec_+${cartItem.getId()}">
                                                            <img src="/img/icon_amount_down.png" th:id="cart_item_dec_+${cartItem.getId()}">
                                                        </a>
                                                    </div>
                                                </div>
                                                <div class="change" style="display: none;">
                                                    <a href="#">수량변경</a>
                                                </div>
                                            </td>
                                            <td>
                                                <strong th:id="cart_item_amount_ + ${cartItem.getId()}">
                                                    <strong th:text="${#numbers.formatInteger(cartItem.getPrice()*cartItem.getCount(), 0, 'COMMA')}">349,000</strong>원
                                                </strong>
                                                <!-- <br><em>($135,58)</em>-->
                                            </td>
                                            <td>
                                                <span th:text="${cartItem.getEarnedPoints()}">0</span>원
                                            </td>
                                            <td>
                                                <a href="javascript:;">
                                                    <img src="/img/icon_trash.png">
                                                </a>
                                            </td>
                                        </tr>
                                    </th:block>
                                    </tbody>
                                </table>
                            </div>
                            <div class="control">
                                <button type="button" onclick="continueShopping()">계속 쇼핑하기</button>
                                <button type="button" onclick="orderAllItems()">전체상품 주문하기</button>
                            </div>
                            <div class="caution">
                                <dl>
                                    <dt>
                                        <img src="/img/icon_caution.png"> 안내사항
                                    </dt>
                                    <dd>
                                        <p>- 상품 쿠폰 및 적립금 사용은 [주문서 작성/결제]에서 적용됩니다.</p>
                                        <p>- 장바구니는 회원에 한해 직접 삭제할 때까지 보관됩니다.</p>
                                    </dd>
                                </dl>
                            </div>
                        </div>
                        <div class="payment">
                            <div class="box">
                                <div class="info">
                                    <dl>
                                        <dt>주문금액</dt>
                                        <dd>
                                            <span id="total_price">174,900</span>원
                                        </dd>
                                    </dl>
                                    <dl>
                                        <dt>배송비</dt>
                                        <dd>
                                            + <span id="delivery_cost">10,000</span>원
                                        </dd>
                                    </dl>
                                </div>
                                <div class="total">
                                    <div class="text">총 상품금액</div>
                                    <div class="price">
                                        <div class="won">
                                            <span id="total_amount">174,900</span><em>원</em>
                                        </div>
                                        <div class="dollar" style="display: none;">($135,58)</div>
                                    </div>
                                </div>
                                <div class="button">
                                    <a href="javascript: orderCheckedItems();" class="btn btn_01">선택상품 주문하기</a>
                                </div>
                            </div>
                        </div>
                        <form id="order_form" method="post" action="/order/form"></form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script type="application/javascript" th:inline="javascript">
        /* <![CDATA[ */
        let cart = [[${cart}]];
        let cartItems = [[${cart.cartItems}]];

        const deliveryCost = document.getElementById("delivery_cost");
        const totalPrice = document.getElementById("total_price");
        const totalAmount = document.getElementById("total_amount");
        deliveryCost.innerHTML = 0;
        totalPrice.innerHTML = 0;
        totalAmount.innerHTML = 0;
        const selectItem = [];

        let allCheckBox = document.getElementById("all_check_box");

        /* 상품 선택 변화 */
        function onChangeCheckBox() {
            let deliveryCostValue = 0;
            let totalAmountValue = 0;

            const checkBoxList = document.getElementsByName("cartItemCheck");
            let checkedFilter = Object.entries(checkBoxList).filter(([index, elem], key) => {
                    return elem.checked;
                }
            );
            let checkedIndexList = checkedFilter.map(([index, elem], key) => {
                return index;
            });
            let checkedIdList = checkedFilter.map(([index, elem], key) => {
                return elem.id.replace("check_", "");
            });

            // 전체 체크박스 전이
            if (checkedIndexList.length === cartItems.length) {
                allCheckBox.checked = true;
            } else {
                allCheckBox.checked = false;
            }

            for (let i = 0; i < cartItems.length; i++) {
                if (checkedIndexList.includes(String(i))) {
                    totalAmountValue += (cartItems[i].price * cartItems[i].count);
                }
            }

            deliveryCost.innerHTML = deliveryCostValue.toLocaleString('ko-KR');
            totalPrice.innerHTML = totalAmountValue.toLocaleString('ko-KR');
            totalAmount.innerHTML = (totalAmountValue + deliveryCostValue).toLocaleString('ko-KR');
        }

        // All 체크박스 동작
        const allCheck = () => {
            let allCheckBoxChecked = allCheckBox.checked;
            const checkBoxList = document.getElementsByName("cartItemCheck");
            Object.entries(checkBoxList).map(([index, elem], key) => {
                checkBoxList[key].checked = allCheckBoxChecked;
            });

            onChangeCheckBox();
        }

        const orderForm = document.getElementById("order_form");

        /* 모든 상품 주문 */
        function orderAllItems() {
            const checkBoxList = document.getElementsByName("cartItemCheck");
            let checkedIdList = Object.entries(checkBoxList).map(([index, elem], key) => {
                return elem.id.replace("check_", "");
            });
            checkedIdList.forEach(id => {
                const idInput = document.createElement('input');
                idInput.setAttribute("type", "hidden");
                idInput.setAttribute("name", "cartItemIds");
                idInput.setAttribute("value", id);

                const itemCountField = document.getElementById("item_count_" + id);
                const countInput = document.createElement('input');
                countInput.setAttribute("type", "hidden");
                countInput.setAttribute("name", "cartItemCounts");
                countInput.setAttribute("value", itemCountField.value);

                orderForm.appendChild(idInput);
                orderForm.appendChild(countInput);
            });

            orderForm.submit();
        }

        /* 선택한 상품 주문 */
        function orderCheckedItems() {
            const checkBoxList = document.getElementsByName("cartItemCheck");
            let checkedFilter = Object.entries(checkBoxList).filter(([index, elem], key) => {
                    return elem.checked;
                }
            );
            let checkedIdList = checkedFilter.map(([index, elem], key) => {
                return elem.id.replace("check_", "");
            });
            checkedIdList.forEach(id => {
                const idInput = document.createElement('input');
                idInput.setAttribute("type", "hidden");
                idInput.setAttribute("name", "cartItemIds");
                idInput.setAttribute("value", id);

                const itemCountField = document.getElementById("item_count_" + id);
                const countInput = document.createElement('input');
                countInput.setAttribute("type", "hidden");
                countInput.setAttribute("name", "cartItemCounts");
                countInput.setAttribute("value", itemCountField.value);

                orderForm.appendChild(idInput);
                orderForm.appendChild(countInput);
            });

            orderForm.submit();
        }

        /* 수량 하나 변경 */
        async function changeOneCount(operator, event) {
            let id = event.target.id;
            id = id.replace('cart_item_' + operator + '_', '');
            const itemCountField = document.getElementById('item_count_' + id);
            let value = itemCountField.value;
            if (operator === 'add') {
                value++;
            } else if (operator === 'dec') {
                value--;
            }

            let cartItem = await changeCartItemCount(id, value);
            itemCountField.value = cartItem.count;
        }

        /* 장바구니 상품 수량 변경 */
        async function changeCountCartItem(event) {
            let id = event.target.id;
            id = id.replace('item_count_', '');

            await changeCartItemCount(id, event.target.value);
        }

        /* 수량변경 요청 */
        async function changeCartItemCount(id, count) {
            let cartItem = {};
            const body = {
                count: count
            }

            await fetch('/api/cart-items/' + id, {
                headers: {
                    'Content-Type': 'application/json'
                },
                method: 'PATCH',
                body: JSON.stringify(body)
            }).then(response => {
                return response.json();
            }).then(data => {
                cartItem = data;
            }).catch(errors => {
                console.log(errors);
            })

            await reloadCartInfo(); // 카트정보 재검색

            // 총금액 재계산
            const cartItemAmount = document.getElementById('cart_item_amount_' + id);
            Object(cartItems).map(cartItem => {
                if (cartItem.id === Number(id)) {
                    cartItemAmount.innerHTML = (cartItem.price * cartItem.count).toLocaleString('ko-KR') + '원';
                }
            });

            await onChangeCheckBox(); // 선택상품 재계산

            return cartItem;
        }

        /* 카트 정보 업데이트 */
        async function reloadCartInfo() {
            await fetch('/api/cart')
                .then(response => {
                return response.json();
            }).then(data => {
                cart = data;
                cartItems = cart.cartItems;
            }).catch(errors => {
                console.log(errors);
            })
        }
        /* ]]> */
    </script>
</div>
</html>
